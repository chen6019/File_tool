<!-- @format -->

# 图片工具 (图片工具.py) 项目文档

## 项目概述

图片工具是一个基于 Python 和 Tkinter 的图形界面应用程序，用于批量处理图片文件。支持图片分类、格式转换、去重、重命名等功能，提供预览模式和实际执行模式。

## 核心功能

### 1. 图片分类 (Classification)

-   **功能描述**: 根据图片宽高比对图片进行自动分类
-   **支持比例**: 16:9, 3:2, 4:3, 1:1, 21:9 (可自定义)
-   **容差设置**: 15% 容差范围 (可调整)
-   **输出结构**: 将图片按比例分类到不同子文件夹

### 2. 格式转换 (Format Conversion)

-   **支持格式**: JPG/JPEG, PNG, WebP, ICO
-   **质量设置**: JPG/WebP 质量可调 (1-100)
-   **PNG 选项**: 支持 24 位 PNG 输出
-   **ICO 选项**: 支持多尺寸 ICO 图标生成
-   **删除源文件**: 可选择转换后删除原文件

### 3. 去重 (Deduplication)

-   **算法**: 基于 aHash 和 dHash 的感知哈希
-   **阈值设置**: 相似度阈值可调 (0-20)
-   **保留策略**: 首个/最大分辨率/最大文件/最新/最旧
-   **处理方式**: 仅列出/删除重复/移动重复

### 4. 重命名 (Rename)

-   **模式支持**: {index}, {name}, {ext}, {fmt}, {ratio}
-   **序号设置**: 起始序号、步长、宽度可配置
-   **分类独立编号**: 分类后每个文件夹独立编号
-   **覆盖处理**: 覆盖/跳过/自动改名

### 5. 预览模式

-   **安全预览**: 所有操作在缓存中执行，不影响原文件
-   **实时预览**: 支持源文件和结果文件的对比预览
-   **错误显示**: 失败操作显示详细错误信息
-   **自动调整**: 预览窗口根据内容自动调整大小

## 技术架构

### 主要技术栈

-   **GUI 框架**: Tkinter + TTK
-   **图像处理**: PIL/Pillow
-   **并发处理**: ThreadPoolExecutor
-   **哈希算法**: 自实现 aHash/dHash

### 核心类和模块

-   `ImageApp`: 主应用程序类
-   `ImgInfo`: 图片信息数据类
-   感知哈希函数: `ahash()`, `dhash()`, `hamming()`
-   文件处理: `convert_one()`, `safe_delete()`

## 文件结构

### 输出文件夹目录结构

```
输出目录/
├── .preview_cache/           # 预览模式缓存 (仅预览时)
│   ├── _final/              # 最终预览结果
│   ├── _trash/              # 模拟删除文件
│   ├── failed/              # 失败文件存放
│   └── program.log          # 程序日志
├── 16x9/                    # 比例分类文件夹 (启用分类时)
│   ├── image001.jpg
│   └── image002.webp
├── 4x3/
│   ├── image001.jpg
│   └── image002.png
├── other/                   # 其他比例图片
│   └── image001.gif
├── failed/                  # 失败文件 (实际模式，启用删源时)
│   ├── corrupted_image1.jpg
│   └── invalid_file2.png
└── 成功处理的文件...
    ├── converted_image1.webp
    ├── renamed_image001.jpg
    └── deduplicated_image.png
```

### 缓存文件夹详细结构

```
.preview_cache/
├── _final/                  # 最终预览结果目录
│   ├── 16x9/               # 分类+处理后的最终结果
│   │   ├── image001.webp
│   │   └── image002.webp
│   ├── 4x3/
│   │   └── image001.jpg
│   └── other/
│       └── image001.gif
├── _trash/                  # 模拟删除的文件
│   ├── original_image1.jpg  # 被"删除"的原文件
│   └── duplicate_image2.png
├── failed/                  # 处理失败的文件
│   ├── corrupted1.jpg       # 转换失败的文件
│   └── invalid2.png         # 重命名失败的文件
├── temp_classified/         # 中间分类结果 (如有)
│   ├── 16x9/
│   └── 4x3/
└── program.log              # 完整程序日志
    # 内容示例:
    # [2025-01-15 10:30:15] LOG	CONVERT	src.jpg	dst.webp	转换
    # [2025-01-15 10:30:16] LOG	DEDUP	dup.jpg	keep.jpg	删除(预览)
    # [2025-01-15 10:30:17] STATUS 预览完成
```

## 操作流程

### 标准处理流程

1. **输入验证**: 检查输入文件夹或文件
2. **文件扫描**: 递归或非递归扫描图片文件
3. **分类处理**: (可选) 按比例分类到子文件夹
4. **格式转换**: (可选) 批量转换图片格式
5. **去重处理**: (可选) 检测和处理重复图片
6. **重命名处理**: (可选) 按模式重命名文件
7. **清理工作**: 删除缓存、更新状态

### 错误处理流程

1. **错误检测**: 在每个处理步骤检测错误
2. **错误记录**: 详细记录错误信息到日志
3. **失败文件处理**: 如启用删源，将失败文件移至 `failed/` 文件夹
4. **跳过后续**: 失败文件不参与后续处理步骤
5. **继续处理**: 其他文件正常处理

## 配置参数

### 默认值设置

-   **比例容差**: 15%
-   **预设比例**: 16:9, 3:2, 4:3, 1:1, 21:9
-   **去重阈值**: 3
-   **去重动作**: 删除重复
-   **重命名宽度**: 3 位数字
-   **工作线程**: 16 个
-   **转换删源**: 启用
-   **重命名删源**: 启用

### 界面布局

-   **上半部分**: 日志显示区域 (可调整高度)
-   **下半部分**: 预览区域 (左右对比显示)
-   **控制面板**: 参数设置和操作按钮
-   **状态栏**: 进度显示和状态信息

## 安全特性

### 预览模式安全性

-   所有操作在独立缓存目录执行
-   原文件绝不被修改
-   删除操作仅模拟到 `_trash` 文件夹
-   可随时清除缓存重新预览

### 数据保护

-   失败文件自动保存到 `failed/` 文件夹
-   支持系统回收站删除 (优先使用)
-   文件名冲突自动处理
-   完整操作日志记录

## 性能优化

### 并发处理

-   多线程图片处理 (默认 16 线程)
-   异步 UI 更新机制
-   大文件分批处理

### 内存管理

-   流式处理大量文件
-   及时释放图片资源
-   限制并发线程数量

## 依赖要求

### 必需依赖

```python
tkinter          # GUI框架 (Python标准库)
PIL/Pillow       # 图像处理
```

### 可选依赖

```python
send2trash       # 回收站删除支持
```

## 使用示例

### 基本使用流程

1. 启动程序: `python 图片工具.py`
2. 选择输入文件夹或文件
3. 配置处理参数 (分类、转换、去重、重命名)
4. 点击"预览"查看效果
5. 确认无误后点击"开始"执行

### 典型应用场景

-   **照片整理**: 分类 + 重命名 + 去重
-   **格式统一**: 批量转换为 WebP 格式
-   **空间清理**: 去重删除相似图片
-   **规范命名**: 按序号重命名文件

## 版本特性

### 当前版本特性

-   ✅ 完整的图片处理流水线
-   ✅ 安全的预览模式
-   ✅ 详细的错误处理和日志
-   ✅ 失败文件自动保护
-   ✅ 自适应界面布局
-   ✅ 多线程并发处理

### 注意事项

-   大量文件处理时建议先使用预览模式
-   ICO 格式转换需要方形图片以获得最佳效果
-   去重功能基于视觉相似度，可能存在误判
-   删除操作优先使用系统回收站，确保安全

---

_文档生成时间: 2025 年 9 月 5 日_
_版本: 最新稳定版_

<!-- @format -->

# 输出文件夹清空功能实现报告

## 功能概述

为图片工具新增了"输出文件夹是否清空"功能，允许用户选择在处理开始前是否清空输出目录。

## 新增功能

### 1. 用户界面

在"输入输出配置"区域新增了一个复选框：

-   **位置**: 输出目录选择框右侧
-   **标签**: "清空输出目录"
-   **默认状态**: 勾选（保持原有行为）
-   **工具提示**: "处理前是否清空输出目录，取消勾选将与现有文件混合"

### 2. 功能行为

#### 2.1 勾选"清空输出目录"（默认）

-   处理开始前会删除输出目录中的所有文件和子目录
-   保留 `.preview_cache` 缓存目录不删除
-   日志中显示 "正在清空输出目录..."
-   统计报告中显示 "输出目录: 已清空"
-   这是原有的默认行为，保持向后兼容

#### 2.2 取消勾选"清空输出目录"

-   处理开始前不会删除输出目录中的现有文件
-   新处理的文件与现有文件混合存储
-   如果文件名冲突，新文件会覆盖同名的现有文件
-   日志中显示 "保留输出目录现有内容..."
-   统计报告中显示 "输出目录: 与现有文件混合"

### 3. 实现细节

#### 3.1 UI 组件添加

```python
# 清空输出目录选项
self.clear_output_var = tk.BooleanVar(value=True)  # 默认清空
cb_clear_output = ttk.Checkbutton(io_frame, text='清空输出目录', variable=self.clear_output_var)
cb_clear_output.grid(row=1, column=4, sticky='w', pady=(8, 0), padx=(8, 0))
```

#### 3.2 逻辑修改

在 `_finalize_to_output` 方法中根据用户选择决定是否清空：

```python
# 根据用户选择决定是否清理输出目录中的文件
if self.clear_output_var.get() and os.path.exists(real_out):
    self.q.put('INFO 正在清空输出目录...')
    # 清空逻辑
elif not self.clear_output_var.get():
    self.q.put('INFO 保留输出目录现有内容...')
```

#### 3.3 统计报告增强

在统计报告中记录输出目录处理方式：

```python
# 添加输出目录处理信息
if self.write_to_output:
    if self.clear_output_var.get():
        report_lines.append("  输出目录: 已清空")
    else:
        report_lines.append("  输出目录: 与现有文件混合")
```

## 使用场景

### 场景 1：全新处理

-   **勾选"清空输出目录"**
-   适用于需要全新处理，不保留任何旧文件的情况
-   确保输出目录只包含本次处理的结果

### 场景 2：增量处理

-   **取消勾选"清空输出目录"**
-   适用于需要在现有结果基础上增加新文件的情况
-   保留之前的处理结果，只添加新的处理文件

### 场景 3：批量处理不同目录

-   **取消勾选"清空输出目录"**
-   适用于分批处理多个输入目录到同一个输出目录
-   每次处理都会添加到同一个输出位置

## 注意事项

1. **文件覆盖**: 取消清空时，如果新文件与现有文件同名，新文件会覆盖旧文件
2. **缓存目录保护**: 无论是否清空，`.preview_cache` 目录都会被保留
3. **权限错误**: 清空过程中的权限错误会被忽略，不会中断处理流程
4. **预览模式**: 此功能只在正式处理模式下生效，预览模式不涉及输出目录操作

## 测试建议

1. 创建一个包含图片文件的输入目录
2. 创建一个包含一些现有文件的输出目录
3. 测试勾选"清空输出目录"的情况
4. 测试取消勾选"清空输出目录"的情况
5. 检查日志信息和统计报告的显示

## 向后兼容性

-   默认行为保持不变（清空输出目录）
-   现有用户的使用习惯不受影响
-   所有原有功能和逻辑保持不变
